name: "LabWired Test Runner"
description: "Run `labwired test` in CI, emit artifact paths, and write a GitHub Actions summary."

inputs:
  script:
    description: "Path to the LabWired test script YAML."
    required: true
  firmware:
    description: "Optional path to firmware ELF (overrides script inputs)."
    required: false
    default: ""
  system:
    description: "Optional path to system manifest YAML (overrides script inputs)."
    required: false
    default: ""
  output_dir:
    description: "Directory to write artifacts (result.json, uart.log, junit.xml)."
    required: false
    default: "out/artifacts"
  no_uart_stdout:
    description: "Disable UART echo to stdout (still captured in uart.log)."
    required: false
    default: "true"
  profile:
    description: "Cargo profile to build (`release` or `debug`)."
    required: false
    default: "release"

outputs:
  artifacts_dir:
    description: "Artifacts directory containing result.json/uart.log/junit.xml."
    value: ${{ inputs.output_dir }}
  result_json:
    description: "Path to result.json."
    value: ${{ inputs.output_dir }}/result.json
  uart_log:
    description: "Path to uart.log."
    value: ${{ inputs.output_dir }}/uart.log
  junit_xml:
    description: "Path to junit.xml."
    value: ${{ inputs.output_dir }}/junit.xml
  summary_md:
    description: "Path to summary.md (markdown snippet for reports)."
    value: ${{ steps.summary.outputs.summary_md }}
  exit_code:
    description: "Exit code from `labwired test`."
    value: ${{ steps.run.outputs.exit_code }}
  status:
    description: "Status from result.json (pass/fail/error/unknown)."
    value: ${{ steps.summary.outputs.status }}
  command:
    description: "Executed command line (best-effort)."
    value: ${{ steps.run.outputs.command }}

runs:
  using: "composite"
  steps:
    - name: Build labwired
      id: build
      shell: bash
      run: |
        set -euo pipefail
        profile="${{ inputs.profile }}"
        if [ "$profile" = "release" ]; then
          cargo build --locked -p labwired-cli --release
          echo "bin=target/release/labwired" >> "$GITHUB_OUTPUT"
        else
          cargo build --locked -p labwired-cli
          echo "bin=target/debug/labwired" >> "$GITHUB_OUTPUT"
        fi

    - name: Run labwired test (capture exit code)
      id: run
      shell: bash
      run: |
        set -euo pipefail

        out="${{ inputs.output_dir }}"
        mkdir -p "$out"

        bin="${{ steps.build.outputs.bin }}"

        args=(test --script "${{ inputs.script }}" --output-dir "$out")
        if [ "${{ inputs.no_uart_stdout }}" = "true" ]; then
          args+=(--no-uart-stdout)
        fi
        if [ -n "${{ inputs.firmware }}" ]; then
          args+=(--firmware "${{ inputs.firmware }}")
        fi
        if [ -n "${{ inputs.system }}" ]; then
          args+=(--system "${{ inputs.system }}")
        fi

        set +e
        "$bin" "${args[@]}"
        code=$?
        set -e

        echo "exit_code=$code" >> "$GITHUB_OUTPUT"
        echo "command=$bin ${args[*]}" >> "$GITHUB_OUTPUT"

        exit 0

    - name: Write summary
      id: summary
      shell: bash
      run: |
        set -euo pipefail

        out="${{ inputs.output_dir }}"
        summary="$out/summary.md"
        result="$out/result.json"

        python3 - "$result" "$summary" "$GITHUB_OUTPUT" <<'PY'
import json
import os
import sys

result_path, summary_path, github_output = sys.argv[1:]

status = "unknown"
stop_reason = "unknown"
message = None
steps_executed = None
cycles = None
instructions = None
firmware_hash = None
assertions = []

try:
    with open(result_path, "r", encoding="utf-8") as f:
        data = json.load(f)
    status = str(data.get("status", "unknown"))
    stop_reason = str(data.get("stop_reason", "unknown"))
    message = data.get("message")
    steps_executed = data.get("steps_executed")
    cycles = data.get("cycles")
    instructions = data.get("instructions")
    firmware_hash = data.get("firmware_hash")
    assertions = data.get("assertions", []) or []
except Exception:
    data = None

passed = sum(1 for a in assertions if a.get("passed") is True)
failed = sum(1 for a in assertions if a.get("passed") is False)

lines = []
lines.append("## LabWired test")
lines.append("")
lines.append(f"- Status: **{status}**")
lines.append(f"- Stop reason: `{stop_reason}`")
if message:
    msg = str(message)
    if len(msg) > 1000:
        msg = msg[:1000] + "â€¦"
    lines.append("- Message:")
    lines.append("")
    lines.append("```")
    lines.append(msg.rstrip())
    lines.append("```")
if steps_executed is not None:
    lines.append(f"- Steps executed: `{steps_executed}`")
if cycles is not None:
    lines.append(f"- Cycles: `{cycles}`")
if instructions is not None:
    lines.append(f"- Instructions: `{instructions}`")
if firmware_hash and stop_reason != "config_error":
    lines.append(f"- Firmware hash: `{firmware_hash}`")
if assertions:
    lines.append(f"- Assertions: `{passed}` passed, `{failed}` failed")
lines.append("")
lines.append("Artifacts:")
lines.append("")
lines.append(f"- `{os.path.dirname(result_path)}/result.json`")
lines.append(f"- `{os.path.dirname(result_path)}/uart.log`")
lines.append(f"- `{os.path.dirname(result_path)}/junit.xml`")

os.makedirs(os.path.dirname(summary_path), exist_ok=True)
with open(summary_path, "w", encoding="utf-8") as f:
    f.write("\n".join(lines).rstrip() + "\n")

with open(github_output, "a", encoding="utf-8") as f:
    f.write(f"summary_md={summary_path}\n")
    f.write(f"status={status}\n")
PY

        cat "$summary" >> "$GITHUB_STEP_SUMMARY" || true
